<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Push Practice</title>
</head>
<body>
  <h2>ğŸ“¢ ì›¹ í‘¸ì‹œ ì•Œë¦¼ ì‹¤í—˜</h2>

  <label for="userId">ğŸ‘¤ ì‚¬ìš©ì ì„ íƒ:</label>
  <select id="userId">
    <option value="">-- IDë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
    <option value="Dagwa">Dagwa</option>
    <option value="LDR">LDR</option>
  </select>

  <br><br>
  <button id="subscribeBtn">ğŸ”” ì•Œë¦¼ í—ˆìš© ë° êµ¬ë…</button>

  <script>
    const vapidPublicKey = 'BEvKBnLcnotYEeOBexk0i-_2oK5aU3epudG8lszhppdiGeiDT2JPbkXF-THFDYXcWjiGNktD7gIOj4mE_MC_9nE'; // ë„ˆì˜ ê³µê°œí‚¤

    async function subscribePush() {
      const userId = document.getElementById('userId').value;
      if (!userId) {
        alert('ë¨¼ì € ì‚¬ìš©ì IDë¥¼ ì„ íƒí•˜ì„¸ìš”.');
        return;
      }

      if (!('Notification' in window) || !('serviceWorker' in navigator)) {
        alert('í‘¸ì‹œ ì•Œë¦¼ì´ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
        return;
      }

      const permission = await Notification.requestPermission();
      if (permission !== 'granted') {
        alert('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
        return;
      }

      await navigator.serviceWorker.register('service-worker.js');
      const registration = await navigator.serviceWorker.ready;
      console.log('âœ… ì„œë¹„ìŠ¤ ì›Œì»¤ ì¤€ë¹„ ì™„ë£Œ');

      const subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
      });

      console.log('ğŸ¯ êµ¬ë… ì •ë³´:', JSON.stringify(subscription));

      await fetch('https://port-0-ltryi-database-1ru12mlw3glz2u.sel5.cloudtype.app/api/save-subscription', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, subscription })
      });

      alert(`ğŸ”” êµ¬ë… ì™„ë£Œ! [${userId}] ë¡œ ë“±ë¡ë¨`);
    }

    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      return Uint8Array.from([...rawData].map(c => c.charCodeAt(0)));
    }

    document.getElementById('subscribeBtn').addEventListener('click', subscribePush);
  </script>
</body>
</html>
